// BEGINLICENSE
//
// This file is part of helPME, which is distributed under the BSD 3-clause license,
// as described in the LICENSE file in the top level directory of this project.
//
// Author: Andrew C. Simmonett
//
// ENDLICENSE

#include "catch.hpp"

#include "helpme.h"

TEST_CASE("Full run with a small toy system, comprising two water molecules.") {
    // Setup parameters and reference values.
    helpme::Matrix<double> coordsD(
        {{2.0, 2.0, 2.0}, {2.5, 2.0, 3.0}, {1.5, 2.0, 3.0}, {0.0, 0.0, 0.0}, {0.5, 0.0, 1.0}, {-0.5, 0.0, 1.0}});
    helpme::Matrix<double> chargesD({-0.834, 0.417, 0.417, -0.834, 0.417, 0.417});
    short nfftx = 8;
    short nffty = 7;
    short nfftz = 6;
    short splineOrder = 4;
    helpme::Matrix<double> refChargeGridD({{-0.002399210936, -0.010444565592, -0.002423909155, 0.000001944100,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000005298328},
                                           {-0.009600314295, -0.042594342523, -0.011520236666, -0.000238216995,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000021192866},
                                           {-0.002405623789, -0.011893263344, -0.005660682536, -0.000434403961,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000005298105},
                                           {-0.000000635776, -0.000141446143, -0.000315942314, -0.000042590703,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000347981325, -0.010240812473, -0.000831489546, 0.000005993087,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000054696748},
                                           {-0.001219330871, -0.055536719558, -0.038634589577, -0.003548261523,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000218782397},
                                           {-0.000041866924, -0.036092635933, -0.063462773164, -0.006330510012,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000054694451},
                                           {0.000029877542, -0.002523366006, -0.006113267446, -0.000618488282,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.005054225648, 0.015222473725, 0.005255018967, 0.000109676300,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000032267624},
                                           {0.020983854333, 0.071560070178, 0.036532099443, 0.006118434692,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000129067786},
                                           {0.006415201620, 0.034151084363, 0.032771135657, 0.010184511930,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000032266269},
                                           {0.000132861769, 0.001847631030, 0.002685792564, 0.000983376915,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000117341952, 0.000488823559, 0.000304696348, 0.000035095608,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000417034},
                                           {0.000634581187, 0.008877851593, 0.015129791761, 0.002684617671,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000001668100},
                                           {0.000410413482, 0.012768254028, 0.024980365284, 0.004548117458,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000417016},
                                           {0.000028606372, 0.001198562792, 0.002408524127, 0.000440503556,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000}});

    using cd = std::complex<double>;
    helpme::Matrix<cd> refTransGridD(
        {{cd(0.000000000000, 0.000000000000), cd(-0.412829849871, -0.021670555757), cd(-0.037534503600, 0.411690376358),
          cd(0.300238798968, -0.000000000000), cd(-0.037534503600, -0.411690376358),
          cd(-0.412829849871, 0.021670555757)},
         {cd(-0.008156084798, 0.015972662687), cd(-0.147259182921, 0.280397712009), cd(0.250204609174, 0.146092753343),
          cd(0.102853536212, -0.235504339414), cd(-0.385003261647, -0.156995093158),
          cd(-0.171997293952, 0.348805914792)},
         {cd(0.026687466240, 0.037808266869), cd(0.113715088781, 0.125335192398), cd(0.105184697378, -0.077490316905),
          cd(-0.104973301015, -0.119407303745), cd(-0.240224509575, 0.185990501475),
          cd(0.132700473441, 0.234116495957)},
         {cd(0.043740084777, -0.001818269814), cd(0.051562515236, -0.016673973318), cd(0.004909631359, -0.020215519847),
          cd(-0.065716101895, 0.011579696934), cd(0.015015970319, 0.164519753632), cd(0.136976160590, 0.022328674629)},
         {cd(0.017793067477, 0.000000000000), cd(0.035696486603, 0.023041008584), cd(0.057701265003, -0.029856984956),
          cd(-0.016017328303, 0.000000000000), cd(0.057701265003, 0.029856984956), cd(0.035696486603, -0.023041008584)},
         {cd(0.000000000000, -0.000000000000), cd(-0.123240818128, 0.282656093276), cd(0.256007025624, 0.118295353269),
          cd(0.072460752451, -0.239264256028), cd(-0.391978511250, -0.102374356826),
          cd(-0.114048826545, 0.361159267104)},
         {cd(0.008908982742, 0.009887122184), cd(0.134565517069, 0.150990449356), cd(0.119036921544, -0.103210167225),
          cd(-0.147303225219, -0.123614716749), cd(-0.246465239368, 0.271903526074),
          cd(0.220544007901, 0.234848430122)},
         {cd(0.028142727024, -0.006046395424), cd(0.074441662917, -0.027942179445),
          cd(-0.011428940797, -0.032165821351), cd(-0.092018421472, 0.043413320121), cd(0.072590742029, 0.230032076315),
          cd(0.195661574536, -0.030757539804)},
         {cd(0.011450305501, -0.013420618527), cd(0.013142355438, -0.000258643992), cd(0.035329413165, -0.007772028801),
          cd(-0.006222792295, 0.027640373529), cd(0.107531036656, 0.031417980696), cd(0.042291147568, -0.069517489226)},
         {cd(0.029976828637, -0.004612364393), cd(0.064881621456, -0.026602990677), cd(0.000437943946, -0.085277273347),
          cd(-0.026441037644, 0.004354745468), cd(0.024519431146, -0.007766696858),
          cd(0.016488559859, -0.006397877739)},
         {cd(0.000000000000, -0.000000000000), cd(0.104602635125, 0.104369438146), cd(0.080283722806, -0.080554118951),
          cd(-0.118345401773, -0.076338981886), cd(-0.152428719240, 0.225049089452),
          cd(0.188026845240, 0.146022371258)},
         {cd(0.005948303222, -0.002161000925), cd(0.066056388732, -0.022121763276),
          cd(-0.011030069835, -0.025930656706), cd(-0.075565600958, 0.053982054871), cd(0.103807236788, 0.195596169124),
          cd(0.166508126930, -0.068818176657)},
         {cd(0.003056830942, -0.008933991328), cd(0.004825962548, -0.000672473853), cd(0.034673381554, 0.002298427101),
          cd(0.008789805760, 0.034427874887), cd(0.127085519548, 0.006665267694), cd(0.020317238747, -0.090534294614)},
         {cd(0.009875061560, -0.004287814105), cd(0.035751012232, -0.005167099280), cd(0.014766970192, -0.054012104429),
          cd(-0.004476354986, 0.000362958471), cd(0.029237219817, -0.034060550877),
          cd(-0.010146617761, -0.019170191327)},
         {cd(0.015156436866, -0.031852779039), cd(0.002804334921, -0.065804857980),
          cd(-0.065156490140, -0.028596945140), cd(-0.013174133242, 0.028094894082), cd(0.017169724243, 0.002334407444),
          cd(0.024422072818, -0.020598539962)},
         {cd(-0.000000000000, -0.000000000000), cd(0.031366158634, 0.006228701208), cd(0.019920061708, -0.006359396779),
          cd(-0.031342217104, 0.026778374726), cd(0.075433202030, 0.095895299281), cd(0.083059736046, -0.048823531279)},
         {cd(0.000907009769, -0.001087361364), cd(0.023264162528, 0.014172039156), cd(0.042838762243, -0.021544747688),
          cd(0.003174821240, 0.012424566774), cd(0.081743803767, -0.007206374211), cd(0.007920271313, -0.056708414199)},
         {cd(0.004479378076, -0.003174561105), cd(0.040937002181, -0.007678249422), cd(0.006365769391, -0.059026968542),
          cd(-0.009980433958, 0.000102898949), cd(0.021729505026, -0.026687789595),
          cd(-0.004884769086, -0.018726723394)},
         {cd(0.003813842664, -0.017127551089), cd(0.004515755844, -0.041523335729),
          cd(-0.044420147280, -0.022215158490), cd(-0.007598567095, 0.018036246964),
          cd(0.010506086078, -0.006320143061), cd(0.007818084276, -0.017539197188)},
         {cd(-0.020928955573, -0.019383622368), cd(-0.042385721742, -0.013776185920),
          cd(-0.028047000172, 0.032873034565), cd(0.018436201640, 0.017004857659), cd(0.018149286618, -0.020216970012),
          cd(-0.012696460281, -0.032228414603)},
         {cd(-0.000000000000, 0.000000000000), cd(0.083059736046, 0.048823531279), cd(0.075433202030, -0.095895299281),
          cd(-0.031342217104, -0.026778374726), cd(0.019920061708, 0.006359396779),
          cd(0.031366158634, -0.006228701208)},
         {cd(0.003437555530, -0.002537249823), cd(0.093590716230, -0.054244109358),
          cd(-0.049329832422, -0.116478830119), cd(-0.052308129845, 0.024491064393), cd(0.034276100905, 0.022283803753),
          cd(0.042136956138, -0.041583486193)},
         {cd(-0.002021300985, -0.016764613606), cd(-0.011463288461, -0.086477160304),
          cd(-0.095033609158, -0.004440241661), cd(0.000311786833, 0.053558397854), cd(0.054502784264, -0.012510898388),
          cd(-0.001891925375, -0.065410674977)},
         {cd(-0.026629286444, -0.009884092762), cd(-0.055313853600, -0.006701993057),
          cd(-0.022641672908, 0.049521531512), cd(0.034157213110, 0.015642015864), cd(0.020046899323, -0.046041277563),
          cd(-0.041891360812, -0.035952751222)},
         {cd(-0.020928955573, 0.019383622368), cd(-0.012696460281, 0.032228414603), cd(0.018149286618, 0.020216970012),
          cd(0.018436201640, -0.017004857659), cd(-0.028047000172, -0.032873034565),
          cd(-0.042385721742, 0.013776185920)},
         {cd(0.000000000000, 0.000000000000), cd(0.188026845240, -0.146022371258), cd(-0.152428719240, -0.225049089452),
          cd(-0.118345401773, 0.076338981886), cd(0.080283722806, 0.080554118951), cd(0.104602635125, -0.104369438146)},
         {cd(-0.002589426149, -0.010094026019), cd(-0.050065343926, -0.220398070870),
          cd(-0.239396058631, 0.035750091707), cd(0.026634841029, 0.145920018003), cd(0.158278850546, -0.051254407857),
          cd(-0.047361187749, -0.176555040714)},
         {cd(-0.033430186483, -0.006869401787), cd(-0.156333248681, -0.019101294412),
          cd(-0.040050218881, 0.151375754094), cd(0.110681652010, 0.026306913361), cd(0.031979071664, -0.152862464400),
          cd(-0.149259499334, -0.053043269723)},
         {cd(-0.028450857308, 0.037562579569), cd(-0.029863257119, 0.078418871792), cd(0.058127907696, 0.043112516044),
          cd(0.041359037670, -0.051451878382), cd(-0.080236065019, -0.074698180687),
          cd(-0.091472779954, 0.058330802122)},
         {cd(0.015156436866, 0.031852779039), cd(0.024422072818, 0.020598539962), cd(0.017169724243, -0.002334407444),
          cd(-0.013174133242, -0.028094894082), cd(-0.065156490140, 0.028596945140),
          cd(0.002804334921, 0.065804857980)},
         {cd(0.000000000000, 0.000000000000), cd(-0.114048826545, -0.361159267104), cd(-0.391978511250, 0.102374356826),
          cd(0.072460752451, 0.239264256028), cd(0.256007025624, -0.118295353269),
          cd(-0.123240818128, -0.282656093276)},
         {cd(-0.016403286886, -0.001787049465), cd(-0.321605114253, -0.040518407456),
          cd(-0.059871474808, 0.318521431920), cd(0.234196685802, 0.026440738475), cd(0.012636980054, -0.323847043329),
          cd(-0.322616350455, -0.032188443393)},
         {cd(-0.026074503739, 0.040516983659), cd(-0.091215070085, 0.179995241965), cd(0.152031217360, 0.102016885586),
          cd(0.083883169365, -0.139740493631), cd(-0.223661600589, -0.139762259529),
          cd(-0.159792354736, 0.191242819499)},
         {cd(0.028089050564, 0.049429296598), cd(0.065656196548, 0.061840740755), cd(0.055968556804, -0.033074062195),
          cd(-0.042786205586, -0.070659384889), cd(-0.145648886581, 0.072250329203),
          cd(0.031198589457, 0.146052145102)},
         {cd(0.029976828637, 0.004612364393), cd(0.016488559859, 0.006397877739), cd(0.024519431146, 0.007766696858),
          cd(-0.026441037644, -0.004354745468), cd(0.000437943946, 0.085277273347),
          cd(0.064881621456, 0.026602990677)}});

    helpme::Matrix<std::complex<double>> refConvolvedGridD(
        {{cd(0.000000000000, 0.000000000000), cd(-2.388477486460, -0.125377645443), cd(-0.066256020991, 0.726717116300),
          cd(0.134567442315, -0.000000000000), cd(-0.066256020991, -0.726717116300),
          cd(-2.388477486460, 0.125377645443)},
         {cd(-0.040243990395, 0.078812775944), cd(-0.397713093484, 0.757289557344), cd(0.329873482099, 0.192610861221),
          cd(0.038734892852, -0.088691509202), cd(-0.507594032572, -0.206984668362),
          cd(-0.464525026500, 0.942044337380)},
         {cd(0.026498698505, 0.037540838675), cd(0.098883419571, 0.108987932470), cd(0.069765797997, -0.051396961066),
          cd(-0.024478033298, -0.027843803413), cd(-0.159333582040, 0.123361820481),
          cd(0.115392572201, 0.203581072189)},
         {cd(0.011728095376, -0.000487535447), cd(0.013621428854, -0.004404815014), cd(0.001217583374, -0.005013427498),
          cd(-0.006724399300, 0.001184892343), cd(0.003723944725, 0.040800724542), cd(0.036185415269, 0.005898634918)},
         {cd(0.000658258461, 0.000000000000), cd(0.001360630972, 0.000878246374), cd(0.002281517187, -0.001180549930),
          cd(-0.000289453965, 0.000000000000), cd(0.002281517187, 0.001180549930), cd(0.001360630972, -0.000878246374)},
         {cd(0.000000000000, -0.000000000000), cd(-0.354400305956, 0.812826525005), cd(0.359381730607, 0.166062586278),
          cd(0.029056144294, -0.095942927893), cd(-0.550258007140, -0.143712749430),
          cd(-0.327967142995, 1.038575990531)},
         {cd(0.021849267256, 0.024248152820), cd(0.240851568427, 0.270249669731), cd(0.130008572752, -0.112723064075),
          cd(-0.050132822078, -0.042070732611), cd(-0.269181978059, 0.296964915528),
          cd(0.394739836530, 0.420342551122)},
         {cd(0.022222494982, -0.004774448186), cd(0.053624055107, -0.020128150173),
          cd(-0.006698274106, -0.018851745937), cd(-0.019806476050, 0.009344486370), cd(0.042543985156, 0.134817209008),
          cd(0.140944823692, -0.022156195130)},
         {cd(0.002746799141, -0.003219455013), cd(0.003137534763, -0.000061747266), cd(0.008087625184, -0.001779176336),
          cd(-0.000599660386, 0.002663569067), cd(0.024616053374, 0.007192218301), cd(0.010096359535, -0.016596228894)},
         {cd(0.001037580549, -0.000159646627), cd(0.002321840816, -0.000952009339), cd(0.000016394081, -0.003192286548),
          cd(-0.000456724208, 0.000075220863), cd(0.000917865301, -0.000290740087),
          cd(0.000590056327, -0.000228953182)},
         {cd(0.000000000000, -0.000000000000), cd(0.115159298155, 0.114902566569), cd(0.067416858178, -0.067643918632),
          cd(-0.034938162255, -0.022536944365), cd(-0.127999362612, 0.188981053897),
          cd(0.207002811222, 0.160759179431)},
         {cd(0.005584942768, -0.002028993149), cd(0.056579278270, -0.018947953774),
          cd(-0.007686598274, -0.018070469548), cd(-0.019339959668, 0.013815952640), cd(0.072340840901, 0.136306405887),
          cd(0.142619205024, -0.058944832465)},
         {cd(0.001443892811, -0.004219967049), cd(0.002218161444, -0.000309089753), cd(0.014587177649, 0.000966953984),
          cd(0.001491240548, 0.005840884815), cd(0.053465193390, 0.002804094656), cd(0.009338430455, -0.041612358085)},
         {cd(0.001744067003, -0.000757284909), cd(0.006418376767, -0.000927648978), cd(0.002664477039, -0.009745669572),
          cd(-0.000356559796, 0.000028911112), cd(0.005275415327, -0.006145712666),
          cd(-0.001821621589, -0.003441623130)},
         {cd(0.000426784909, -0.000896931483), cd(0.000082328597, -0.001931873968),
          cd(-0.002042636904, -0.000896505864), cd(-0.000195267432, 0.000416423436), cd(0.000538265832, 0.000073182990),
          cd(0.000716973916, -0.000604724094)},
         {cd(-0.000000000000, -0.000000000000), cd(0.011467143104, 0.002277148724), cd(0.006836689088, -0.002182584532),
          cd(-0.004438300877, 0.003792025422), cd(0.025889144158, 0.032911863216), cd(0.030365780220, -0.017849377941)},
         {cd(0.000282797201, -0.000339029149), cd(0.007218651469, 0.004397450850), cd(0.012746026560, -0.006410314208),
          cd(0.000397642362, 0.001556161341), cd(0.024321633945, -0.002144147783), cd(0.002457585915, -0.017596089134)},
         {cd(0.000864759611, -0.000612860129), cd(0.008033544876, -0.001506792340), cd(0.001255526284, -0.011641940812),
          cd(-0.000868983641, 0.000008959280), cd(0.004285729348, -0.005263656165),
          cd(-0.000958595148, -0.003674963108)},
         {cd(0.000323090719, -0.001450965152), cd(0.000396742989, -0.003648136195),
          cd(-0.004113337339, -0.002057139530), cd(-0.000327541234, 0.000777464292),
          cd(0.000972871069, -0.000585249758), cd(0.000686877288, -0.001540949901)},
         {cd(-0.000313124458, -0.000290004259), cd(-0.000667504001, -0.000216951814),
          cd(-0.000483282047, 0.000566440167), cd(0.000154798163, 0.000142779993), cd(0.000312733067, -0.000348361629),
          cd(-0.000199947947, -0.000507543456)},
         {cd(-0.000000000000, 0.000000000000), cd(0.030365780220, 0.017849377941), cd(0.025889144158, -0.032911863216),
          cd(-0.004438300877, -0.003792025422), cd(0.006836689088, 0.002182584532),
          cd(0.011467143104, -0.002277148724)},
         {cd(0.001071797807, -0.000791090870), cd(0.029040321585, -0.016831438451),
          cd(-0.014677346434, -0.034656516310), cd(-0.006551527385, 0.003067474971), cd(0.010198336031, 0.006630209175),
          cd(0.013074702344, -0.012902965810)},
         {cd(-0.000390219228, -0.003236467315), cd(-0.002249574648, -0.016970420672),
          cd(-0.018743562143, -0.000875752760), cd(0.000027146881, 0.004663261316), cd(0.010749631976, -0.002467535470),
          cd(-0.000371274558, -0.012836298820)},
         {cd(-0.002255907248, -0.000837333608), cd(-0.004859736527, -0.000588820311),
          cd(-0.002096635070, 0.004585729160), cd(0.001472369144, 0.000674259385), cd(0.001856357184, -0.004263455160),
          cd(-0.003680469956, -0.003158718603)},
         {cd(-0.000313124458, 0.000290004259), cd(-0.000199947947, 0.000507543456), cd(0.000312733067, 0.000348361629),
          cd(0.000154798163, -0.000142779993), cd(-0.000483282047, -0.000566440167),
          cd(-0.000667504001, 0.000216951814)},
         {cd(0.000000000000, 0.000000000000), cd(0.207002811222, -0.160759179431), cd(-0.127999362612, -0.188981053897),
          cd(-0.034938162255, 0.022536944365), cd(0.067416858178, 0.067643918632), cd(0.115159298155, -0.114902566569)},
         {cd(-0.002431247417, -0.009477418267), cd(-0.042882468751, -0.188777558404),
          cd(-0.166829526782, 0.024913404657), cd(0.006816815386, 0.037346189631), cd(0.110300837395, -0.035718000777),
          cd(-0.040566277877, -0.151224688031)},
         {cd(-0.015790734535, -0.003244759047), cd(-0.071855589669, -0.008779544882),
          cd(-0.016849226453, 0.063684155331), cd(0.018777771870, 0.004463117497), cd(0.013453674793, -0.064309618045),
          cd(-0.068604275986, -0.024380325082)},
         {cd(-0.005024799201, 0.006634050347), cd(-0.005361348496, 0.014078534658), cd(0.010488304193, 0.007779003248),
          cd(0.003294414778, -0.004098350398), cd(-0.014477387721, -0.013478160022),
          cd(-0.016422101893, 0.010472124892)},
         {cd(0.000426784909, 0.000896931483), cd(0.000716973916, 0.000604724094), cd(0.000538265832, -0.000073182990),
          cd(-0.000195267432, -0.000416423436), cd(-0.002042636904, 0.000896505864),
          cd(0.000082328597, 0.001931873968)},
         {cd(0.000000000000, 0.000000000000), cd(-0.327967142995, -1.038575990531), cd(-0.550258007140, 0.143712749430),
          cd(0.029056144294, 0.095942927893), cd(0.359381730607, -0.166062586278),
          cd(-0.354400305956, -0.812826525005)},
         {cd(-0.040229037303, -0.004382736221), cd(-0.575623665479, -0.072521714318),
          cd(-0.065389837769, 0.347879600864), cd(0.079705931510, 0.008998776745), cd(0.013801732433, -0.353696074689),
          cd(-0.577433622670, -0.057612360472)},
         {cd(-0.020589352553, 0.031993646717), cd(-0.065706779687, 0.129659580346), cd(0.089102462295, 0.059790060616),
          cd(0.018055406281, -0.030078398391), cd(-0.131083600326, -0.081911870971),
          cd(-0.115106429656, 0.137761773310)},
         {cd(0.006738246412, 0.011857530737), cd(0.015674404791, 0.014763523539), cd(0.012812347248, -0.007571329224),
          cd(-0.004123099623, -0.006809103056), cd(-0.033342008758, 0.016539577924),
          cd(0.007448182286, 0.034867698151)},
         {cd(0.001037580549, 0.000159646627), cd(0.000590056327, 0.000228953182), cd(0.000917865301, 0.000290740087),
          cd(-0.000456724208, -0.000075220863), cd(0.000016394081, 0.003192286548),
          cd(0.002321840816, 0.000952009339)}});

    helpme::Matrix<double> refPotentialGridD({{-8.614650681037, -12.398837777289, -9.963264977855, -5.397376568283,
                                               -2.788352319510, -1.751742536046, -2.060066294679, -3.983716350978},
                                              {-14.036107672996, -22.021379367241, -17.615422341249, -8.726743215649,
                                               -3.964593289257, -2.194459441029, -2.584942556638, -5.506646752725},
                                              {-10.343135349161, -16.243954549750, -14.693019985746, -8.377224564407,
                                               -3.906286644646, -2.165759827359, -2.345971975273, -4.581062689742},
                                              {-4.746512588530, -6.801870773739, -6.893964150226, -4.806835904618,
                                               -2.669791228776, -1.657612464642, -1.679526444958, -2.715536834397},
                                              {-2.341594724705, -2.958732642771, -2.944931989527, -2.325237349694,
                                               -1.586961445305, -1.149706013709, -1.158298145583, -1.599933636996},
                                              {-1.920710642059, -2.304628540559, -2.218317740178, -1.754207954481,
                                               -1.261299285904, -0.987536118587, -1.032149064632, -1.387226981283},
                                              {-3.337829218669, -4.127644941789, -3.735448665467, -2.627917467556,
                                               -1.675217072058, -1.230337614559, -1.364534715021, -2.127605975460},
                                              {-4.067372566961, -7.395281287626, -6.337240331705, -3.287479764105,
                                               -1.504282225967, -0.721683248747, -0.720850930418, -1.350102900549},
                                              {-7.857634930805, -18.000635042530, -17.624947014047, -8.237549985936,
                                               -2.620213553991, -1.034346603963, -0.953110400883, -1.927987715298},
                                              {-6.892939440945, -17.164131457688, -19.783650814848, -9.954021056642,
                                               -2.842751448494, -1.167287506179, -0.915119540699, -1.975702219011},
                                              {-3.221811604903, -6.598381571626, -7.846835353750, -4.747685797311,
                                               -1.849904865314, -0.876679318188, -0.721846923794, -1.343011853289},
                                              {-1.295852934517, -1.793013366884, -1.844998858739, -1.474930014239,
                                               -0.924906110611, -0.556810575821, -0.509929955537, -0.760614353765},
                                              {-0.896480074981, -1.248490333898, -1.297957439201, -0.964422264206,
                                               -0.615981450694, -0.428907874343, -0.412388137542, -0.577472305953},
                                              {-1.395483335722, -1.859171732294, -1.727441981147, -1.243215880953,
                                               -0.770833021788, -0.493905116235, -0.485326544132, -0.785994799261},
                                              {7.864664665990, 11.102939169020, 8.573856446908, 4.270485997269,
                                               2.034568790312, 1.320065927523, 1.682026068070, 3.539282693454},
                                              {14.177218990765, 22.295233161318, 17.704539208643, 8.238971540821,
                                               3.215033674025, 1.683962133934, 2.168836947771, 5.254915486840},
                                              {9.778713070437, 15.971192776352, 14.512518457138, 7.885669123634,
                                               3.173908951127, 1.594362653827, 1.882589262077, 3.989335112591},
                                              {3.437288786014, 4.986478741863, 5.011855323439, 3.408467478263,
                                               1.809363290458, 1.125785319039, 1.212102326663, 1.953776893817},
                                              {1.357237798079, 1.561028477396, 1.466619663216, 1.192102998248,
                                               0.901314857146, 0.731394178556, 0.769179812708, 1.010853613781},
                                              {1.189444324081, 1.382293387982, 1.295253917012, 1.011376187162,
                                               0.756518196508, 0.646881148156, 0.703231416502, 0.905286622152},
                                              {2.386862141330, 2.801494471051, 2.442648117784, 1.689436924591,
                                               1.101275887049, 0.872699114680, 1.024656030934, 1.590554962830},
                                              {6.017029103528, 8.247549173444, 7.780564667036, 5.214108140801,
                                               2.976315748608, 1.981740004084, 2.140940882463, 3.480112786891},
                                              {9.554263744364, 15.608626446446, 16.020538024685, 9.784589362501,
                                               4.491299451087, 2.572823902696, 2.674175873056, 4.732098962986},
                                              {8.799293338923, 15.542053564694, 17.133709882131, 10.566481835107,
                                               4.627743796157, 2.559590980114, 2.514496765866, 4.307828390412},
                                              {4.816705801038, 7.464309154878, 8.113378882777, 5.667168909629,
                                               3.068568414818, 1.913313788048, 1.854300493988, 2.781806870297},
                                              {2.290827258284, 2.819206989281, 2.845042763417, 2.363396304920,
                                               1.708405162244, 1.287759268582, 1.274196697241, 1.651079106571},
                                              {1.807961780289, 2.142035109226, 2.127699888106, 1.748145679787,
                                               1.323120908492, 1.089092867154, 1.116345829647, 1.394018981095},
                                              {2.870197280595, 3.418596364314, 3.211401847311, 2.480338981567,
                                               1.745300607938, 1.358652528188, 1.450794363307, 2.021883651780},
                                              {1.166446512762, 1.346657915112, 1.608054020858, 1.527107378446,
                                               1.120436602752, 0.816282838573, 0.763525615581, 0.955850174362},
                                              {1.390238459362, 1.285828137724, 1.706745698993, 1.997357417123,
                                               1.535653251094, 1.050004871734, 0.952727849944, 1.233554544914},
                                              {1.711443236122, 1.762750392234, 1.871932871298, 2.042052719587,
                                               1.604241291371, 1.073043239806, 0.971292319789, 1.291506020646},
                                              {1.490353237940, 1.877338697695, 1.957391584770, 1.719191482109,
                                               1.247005757105, 0.865828629740, 0.790799749233, 1.028387842198},
                                              {0.927518700589, 1.168420917047, 1.237955981500, 1.064780407674,
                                               0.799996122147, 0.612301543701, 0.572784055734, 0.691812475590},
                                              {0.675887357258, 0.779975884938, 0.801626773351, 0.728216231021,
                                               0.599494763050, 0.497115905134, 0.478086958985, 0.550043209791},
                                              {0.852525856505, 1.025565240653, 1.066360816150, 0.931867082736,
                                               0.725445834667, 0.579069560675, 0.558248240686, 0.665923374989},
                                              {-2.634628650998, -2.986785952942, -2.706951707417, -1.938008272298,
                                               -1.192417143753, -0.879136718593, -1.067293523547, -1.783088592542},
                                              {-3.023568577027, -2.929416257951, -2.556505776726, -2.082649319844,
                                               -1.394492846420, -1.022191136490, -1.249894516359, -2.163798827771},
                                              {-2.623877166895, -2.455695103051, -1.891062933886, -1.652499236916,
                                               -1.264998571167, -0.941697164926, -1.124273777573, -1.861627026433},
                                              {-1.753715843524, -1.932343684323, -1.682529546600, -1.328878757610,
                                               -0.955784069701, -0.724359173903, -0.816611366034, -1.228937336063},
                                              {-1.074345662363, -1.254256289749, -1.203033501626, -0.950264641239,
                                               -0.679484543335, -0.538982443685, -0.582933535252, -0.795462417999},
                                              {-0.995367871919, -1.123132092424, -1.051321589532, -0.839708179827,
                                               -0.617908748042, -0.504909546894, -0.555810044220, -0.752819045518},
                                              {-1.630299557431, -1.912135040418, -1.730318112922, -1.253969924436,
                                               -0.829678762035, -0.645530934233, -0.751476829656, -1.130482039066}});

    helpme::Matrix<double> refForcesD({{-0.44265939, -0.56937319, 5.93436350},
                                       {0.44425250, 0.37884938, -2.30464437},
                                       {0.29045422, 0.46126952, -2.41671313},
                                       {-1.00722216, -0.87531712, 4.41462586},
                                       {0.28648932, 0.32873408, -2.98969056},
                                       {0.42103402, 0.25635242, -2.80468465}});

    double refRecEnergy = 5.3664407441;

    SECTION("double precision tests") {
        constexpr double TOL = 1e-7;
        helpme::Matrix<double> forcesD(6, 3);
        forcesD.setZero();
        double ccelec = 332.0716;

        auto pmeD = std::unique_ptr<PMEInstanceD>(new PMEInstanceD);
        pmeD->setup(1, 0.3, splineOrder, nfftx, nffty, nfftz, ccelec, 1);
        pmeD->setLatticeVectors(20, 20, 20, 90, 90, 90, PMEInstanceD::LatticeType::XAligned);
        auto realGrid = pmeD->spreadParameters(0, chargesD, coordsD);
        helpme::Matrix<double> chargeGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refChargeGridD.almostEquals(chargeGrid, TOL));

        auto gridAddress = pmeD->forwardTransform(realGrid);
        helpme::Matrix<std::complex<double>> complexGrid(gridAddress, nffty * (nfftx / 2 + 1), nfftz);
        REQUIRE(refTransGridD.almostEquals(complexGrid, TOL));

        double energy = pmeD->convolveE(gridAddress);
        REQUIRE(refConvolvedGridD.almostEquals(complexGrid, TOL));

        realGrid = pmeD->inverseTransform(gridAddress);
        helpme::Matrix<double> potentialGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refPotentialGridD.almostEquals(potentialGrid, TOL));

        pmeD->probeGrid(realGrid, 0, chargesD, coordsD, forcesD);
        REQUIRE(refForcesD.almostEquals(forcesD, TOL));
        REQUIRE(refRecEnergy == Approx(energy).margin(TOL));
    }

    SECTION("single precision tests") {
        constexpr float TOL = 2e-5;
        helpme::Matrix<float> forcesF(6, 3);
        forcesF.setZero();
        float ccelec = 332.0716f;

        auto pmeF = std::unique_ptr<PMEInstanceF>(new PMEInstanceF);
        pmeF->setup(1, 0.3, splineOrder, nfftx, nffty, nfftz, ccelec, 1);
        pmeF->setLatticeVectors(20, 20, 20, 90, 90, 90, PMEInstanceF::LatticeType::XAligned);
        auto realGrid = pmeF->spreadParameters(0, chargesD.cast<float>(), coordsD.cast<float>());
        helpme::Matrix<float> chargeGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refChargeGridD.cast<float>().almostEquals(chargeGrid, TOL));

        auto gridAddress = pmeF->forwardTransform(realGrid);
        helpme::Matrix<std::complex<float>> complexGrid(gridAddress, nffty * (nfftx / 2 + 1), nfftz);
        REQUIRE(refTransGridD.cast<std::complex<float>>().almostEquals(complexGrid, TOL));

        float energy = pmeF->convolveE(gridAddress);
        REQUIRE(refConvolvedGridD.cast<std::complex<float>>().almostEquals(complexGrid, TOL));

        realGrid = pmeF->inverseTransform(gridAddress);
        helpme::Matrix<float> potentialGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refPotentialGridD.cast<float>().almostEquals(potentialGrid, TOL));

        pmeF->probeGrid(realGrid, 0, chargesD.cast<float>(), coordsD.cast<float>(), forcesF);
        REQUIRE(refForcesD.cast<float>().almostEquals(forcesF, TOL));
        REQUIRE(refRecEnergy == Approx(energy).margin(TOL));
    }
}
