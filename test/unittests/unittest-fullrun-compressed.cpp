// BEGINLICENSE
//
// This file is part of helPME, which is distributed under the BSD 3-clause license,
// as described in the LICENSE file in the top level directory of this project.
//
// Author: Andrew C. Simmonett
//
// ENDLICENSE

#include "catch.hpp"

#include "helpme.h"

TEST_CASE("Full run with a small toy system, comprising two water molecules.") {
    // Setup parameters and reference values.
    helpme::Matrix<double> coordsD(
        {{2.0, 2.0, 2.0}, {2.5, 2.0, 3.0}, {1.5, 2.0, 3.0}, {0.0, 0.0, 0.0}, {0.5, 0.0, 1.0}, {-0.5, 0.0, 1.0}});
    helpme::Matrix<double> chargesD({-0.834, 0.417, 0.417, -0.834, 0.417, 0.417});
    short nfftx = 8;
    short nffty = 7;
    short nfftz = 6;
    short kMaxX = 3;
    short kMaxY = 2;
    short kMaxZ = 1;
    short kDimX = 2 * kMaxX + 1;
    short kDimY = 2 * kMaxY + 1;
    short kDimZ = 2 * kMaxZ + 1;
    short splineOrder = 4;
    helpme::Matrix<double> refChargeGridD({{-0.002399210936, -0.010444565592, -0.002423909155, 0.000001944100,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000005298328},
                                           {-0.009600314295, -0.042594342523, -0.011520236666, -0.000238216995,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000021192866},
                                           {-0.002405623789, -0.011893263344, -0.005660682536, -0.000434403961,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000005298105},
                                           {-0.000000635776, -0.000141446143, -0.000315942314, -0.000042590703,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000347981325, -0.010240812473, -0.000831489546, 0.000005993087,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000054696748},
                                           {-0.001219330871, -0.055536719558, -0.038634589577, -0.003548261523,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000218782397},
                                           {-0.000041866924, -0.036092635933, -0.063462773164, -0.006330510012,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000054694451},
                                           {0.000029877542, -0.002523366006, -0.006113267446, -0.000618488282,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.005054225648, 0.015222473725, 0.005255018967, 0.000109676300,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000032267624},
                                           {0.020983854333, 0.071560070178, 0.036532099443, 0.006118434692,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000129067786},
                                           {0.006415201620, 0.034151084363, 0.032771135657, 0.010184511930,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000032266269},
                                           {0.000132861769, 0.001847631030, 0.002685792564, 0.000983376915,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000117341952, 0.000488823559, 0.000304696348, 0.000035095608,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000417034},
                                           {0.000634581187, 0.008877851593, 0.015129791761, 0.002684617671,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000001668100},
                                           {0.000410413482, 0.012768254028, 0.024980365284, 0.004548117458,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000417016},
                                           {0.000028606372, 0.001198562792, 0.002408524127, 0.000440503556,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, 0.000000000000},
                                           {-0.000000000000, -0.000000000000, -0.000000000000, 0.000000000000,
                                            0.000000000000, 0.000000000000, 0.000000000000, -0.000000000000}});
    helpme::Matrix<double> refTransGridD(
        {{0.00000000, -0.41282985, 0.02167056},   {-0.00815608, -0.15962824, 0.03420410},
         {-0.01597266, -0.31460181, -0.01236906}, {0.02668747, 0.12320778, 0.05439065},
         {-0.03780827, -0.17972584, 0.00949269},  {0.04374008, 0.09426934, 0.01950132},
         {0.00181827, -0.00282735, 0.04270682},   {0.00000000, -0.11864482, 0.03925159},
         {-0.00374715, -0.07227798, 0.02304699},  {-0.00405004, -0.07828301, 0.02124181},
         {0.00103411, 0.00477395, 0.00210805},    {-0.01723529, -0.07813459, 0.01316066},
         {0.01976968, 0.03807207, 0.00373814},    {-0.01800434, -0.03452919, -0.00132720},
         {0.00000000, -0.32190768, 0.00459600},   {-0.00583709, -0.11463643, 0.02174743},
         {-0.01265613, -0.24983275, -0.01888200}, {0.02328169, 0.10748445, 0.04744930},
         {-0.02710862, -0.13027767, 0.00351573},  {0.03142496, 0.06941725, 0.01590160},
         {0.00831937, 0.01035532, 0.03836756},    {0.00000000, 0.14631474, 0.02082647},
         {0.00167944, 0.03378450, -0.00071335},   {0.00612751, 0.12197326, 0.02578897},
         {-0.01518668, -0.07011239, -0.03095095}, {0.00790170, 0.04083783, 0.00564126},
         {-0.00928790, -0.02393291, -0.00852279}, {-0.01663738, -0.02810310, -0.02687679},
         {0.00000000, -0.12519590, 0.04171211},   {-0.00396651, -0.07650329, 0.02443690},
         {-0.00426886, -0.08249776, 0.02263486},  {0.00103229, 0.00476555, 0.00210438},
         {-0.01824351, -0.08268399, 0.01397996},  {0.02092520, 0.04027174, 0.00392797},
         {-0.01916296, -0.03673511, -0.00152124}});

    helpme::Matrix<double> refConvolvedGridD(
        {{0.00000000, -4.77695497, 0.25075529},   {-0.08048798, -1.72447624, 0.36950956},
         {-0.15762555, -3.39866779, -0.13362387}, {0.05299740, 0.42855198, 0.18918628},
         {-0.07508168, -0.62513801, 0.03301831},  {0.02345619, 0.09961369, 0.02060690},
         {0.00097507, -0.00298764, 0.04512797},   {0.00000000, -1.36473490, 0.45149893},
         {-0.03675954, -1.03493177, 0.33000447},  {-0.03973083, -1.12091629, 0.30415662},
         {0.00326628, 0.02751134, 0.01214830},    {-0.05443840, -0.45027402, 0.07584224},
         {0.01897009, 0.07271296, 0.00713939},    {-0.01727615, -0.06594649, -0.00253480},
         {0.00000000, -3.70280503, 0.05286633},   {-0.05726178, -1.64145259, 0.31139645},
         {-0.12415661, -3.57729739, -0.27036706}, {0.07353619, 0.61941140, 0.27344084},
         {-0.08562370, -0.75076418, 0.02026048},  {0.03015397, 0.13257840, 0.03037009},
         {0.00798289, 0.01977739, 0.07327731},    {0.00000000, 0.64432422, 0.09171323},
         {0.00630739, 0.23149947, -0.00488802},   {0.02301282, 0.83579007, 0.17671224},
         {-0.02869368, -0.25780655, -0.11380810}, {0.01492945, 0.15016264, 0.02074317},
         {-0.00656146, -0.03437339, -0.01224077}, {-0.01175353, -0.04036277, -0.03860150},
         {0.00000000, -0.55132349, 0.18368703},   {-0.01489685, -0.52421892, 0.16744747},
         {-0.01603238, -0.56529446, 0.15509950},  {0.00195042, 0.01752316, 0.00773791},
         {-0.03446925, -0.30403292, 0.05140498},  {0.01478267, 0.05783986, 0.00564151},
         {-0.01353773, -0.05276041, -0.00218487}});

    helpme::Matrix<double> refPotentialGridD(
        {{-7.73656946, -11.35129882, -9.44397849, -5.29390735, -2.80650829, -1.72311251, -2.00240636, -3.62114393},
         {-12.07085832, -20.27899037, -18.17541940, -9.46608407, -4.08605032, -2.19954534, -2.48246836, -4.87017661},
         {-9.96085889, -17.45134064, -17.37199343, -9.73411360, -4.08832801, -2.20815409, -2.27700620, -4.30457820},
         {-4.73847144, -7.43123617, -8.11279575, -5.48528560, -2.78265496, -1.69273642, -1.65082412, -2.67548808},
         {-2.35481203, -2.87972244, -2.76007924, -2.25835941, -1.60586961, -1.14909705, -1.15962675, -1.59320873},
         {-1.96345709, -2.51387175, -2.47172369, -1.85306615, -1.27119780, -0.98840309, -1.02574650, -1.37678410},
         {-3.01607231, -3.58976000, -3.35350589, -2.51576460, -1.65396976, -1.22317655, -1.33148677, -2.02633358},
         {-2.51364931, -4.42560826, -3.89985680, -2.23474468, -1.20352730, -0.62651586, -0.62731397, -0.95747858},
         {-4.10079791, -9.07853545, -9.17157841, -4.66980009, -1.82050533, -0.85996612, -0.77787159, -1.26245158},
         {-3.92332468, -8.95978127, -10.09202155, -5.40409612, -1.92736407, -0.95532345, -0.76955576, -1.39306523},
         {-2.28731056, -4.28944610, -5.06770232, -3.22472533, -1.41009863, -0.77284206, -0.63771295, -1.11581097},
         {-1.12263845, -1.45362671, -1.43030923, -1.21239572, -0.82731169, -0.51388265, -0.48432859, -0.68468287},
         {-0.82328178, -1.18014533, -1.24011457, -0.90171899, -0.57613909, -0.41292696, -0.39461587, -0.53936002},
         {-1.13170808, -1.43214422, -1.39414127, -1.07846043, -0.69519242, -0.46447792, -0.44690478, -0.69286398},
         {5.17541484, 6.56417604, 5.37026274, 3.13444294, 1.70562630, 1.22892992, 1.49381134, 2.81756632},
         {8.00150182, 10.59639619, 8.59694767, 4.95577593, 2.47573009, 1.51785011, 1.86986357, 3.87402091},
         {6.10728016, 8.04254574, 6.81833146, 4.41905646, 2.38915584, 1.41196378, 1.67115300, 3.11235447},
         {2.46087167, 2.98334786, 2.81047184, 2.24143954, 1.48793677, 1.02448137, 1.12264152, 1.63265303},
         {1.20446658, 1.34746911, 1.26667652, 1.02420679, 0.80983111, 0.70079215, 0.73482547, 0.94333163},
         {1.12098604, 1.26609977, 1.16714937, 0.94306094, 0.72880091, 0.62730741, 0.68103746, 0.86150567},
         {1.83962690, 2.06144867, 1.88274600, 1.42734561, 1.00756350, 0.83127127, 0.95715178, 1.36702264},
         {7.64155884, 10.62826979, 9.09626059, 5.44446790, 3.01179892, 1.98777905, 2.23984427, 3.92894587},
         {12.13374114, 19.07087292, 17.36163277, 9.78506797, 4.50642053, 2.55608712, 2.81300195, 5.40276838},
         {10.10035080, 16.55331338, 16.44871259, 9.91219157, 4.54471180, 2.52642036, 2.60441133, 4.70626121},
         {4.75789302, 7.11435175, 7.64355256, 5.44704416, 3.01341585, 1.90191045, 1.86988483, 2.82143991},
         {2.29939803, 2.72246920, 2.63389225, 2.21484561, 1.66841599, 1.28025255, 1.27868136, 1.66282027},
         {1.92507855, 2.37861846, 2.34280419, 1.83649372, 1.33868220, 1.09206564, 1.12556014, 1.42494727},
         {2.92659766, 3.39742577, 3.20026866, 2.49584748, 1.75154207, 1.36832183, 1.47662634, 2.09343966},
         {2.41863868, 3.70257923, 3.55213890, 2.38530523, 1.40881793, 0.89118240, 0.86475188, 1.26528052},
         {4.16368073, 7.87041800, 8.35779178, 4.98878400, 2.24087555, 1.21650790, 1.10840518, 1.79504334},
         {4.06281660, 8.06175400, 9.16874071, 5.58217410, 2.38374786, 1.27358972, 1.09696089, 1.79474824},
         {2.30673213, 3.97256169, 4.59845913, 3.18648389, 1.64085953, 0.98201609, 0.85677367, 1.26176279},
         {1.06722445, 1.29637347, 1.30412224, 1.16888192, 0.88985808, 0.64503815, 0.60338319, 0.75429441},
         {0.78490324, 1.04489204, 1.11119507, 0.88514656, 0.64362349, 0.51658951, 0.49442950, 0.58752319},
         {1.04223343, 1.23980998, 1.24090404, 1.05854331, 0.79276473, 0.60962320, 0.59204436, 0.75997006},
         {-5.27042547, -7.28720508, -5.71798064, -2.98388239, -1.50033568, -0.96426337, -1.25637344, -2.50976438},
         {-7.93861900, -11.80451364, -9.41073430, -4.63679203, -2.05535988, -1.16130834, -1.53932998, -3.34142915},
         {-5.96778824, -8.94057301, -7.74161230, -4.24097849, -1.93277205, -1.09369750, -1.34374787, -2.71067146},
         {-2.44145010, -3.30023227, -3.27971502, -2.27968098, -1.25717588, -0.81530734, -0.90358081, -1.48670121},
         {-1.25988058, -1.50472235, -1.39286351, -1.06772059, -0.74728472, -0.56963665, -0.61577086, -0.87372009},
         {-1.15936458, -1.40135306, -1.29606887, -0.95963337, -0.66131651, -0.52364486, -0.58122382, -0.81334249},
         {-1.92910156, -2.25378290, -2.03598324, -1.44726273, -0.90999119, -0.68612599, -0.81201220, -1.29991656}});

    double refRecEnergy = 3.4299612610;

    helpme::Matrix<double> refForcesD({{-0.22266549, -0.30688802, 3.54221958},
                                       {0.23324375, 0.22326760, -1.57202939},
                                       {0.18018847, 0.25962513, -1.66253967},
                                       {-0.65609623, -0.52385981, 3.20743319},
                                       {0.18069794, 0.19198177, -1.81335435},
                                       {0.28074083, 0.14940333, -1.71141651}});

    helpme::Matrix<double> refVirialD({0.56219508, 0.37740965, 0.69824092, 0.52674461, 0.50357589, -2.36105921});

    SECTION("double precision tests E") {
        constexpr double TOL = 1e-7;
        helpme::Matrix<double> forcesD(6, 3);
        forcesD.setZero();
        double ccelec = 332.0716;

        auto pmeD = std::unique_ptr<PMEInstanceD>(new PMEInstanceD);
        pmeD->setupCompressed(1, 0.3, splineOrder, nfftx, nffty, nfftz, kMaxX, kMaxY, kMaxZ, ccelec, 1);
        pmeD->setLatticeVectors(20, 20, 20, 90, 90, 90, PMEInstanceD::LatticeType::XAligned);
        auto realGrid = pmeD->spreadParameters(0, chargesD, coordsD);
        helpme::Matrix<double> chargeGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refChargeGridD.almostEquals(chargeGrid, TOL));

        auto gridAddress = pmeD->compressedForwardTransform(realGrid);
        helpme::Matrix<double> transformedGrid(gridAddress, kDimY * kDimX, kDimZ);
        REQUIRE(refTransGridD.almostEquals(transformedGrid, TOL));

        double energy = pmeD->convolveE(gridAddress);
        helpme::Matrix<double> convolvedGrid(gridAddress, kDimY * kDimX, kDimZ);
        REQUIRE(refConvolvedGridD.almostEquals(convolvedGrid, TOL));

        realGrid = pmeD->compressedInverseTransform(gridAddress);
        helpme::Matrix<double> potentialGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refPotentialGridD.almostEquals(potentialGrid, TOL));

        pmeD->probeGrid(realGrid, 0, chargesD, coordsD, forcesD);
        REQUIRE(refForcesD.almostEquals(forcesD, TOL));
        REQUIRE(refRecEnergy == Approx(energy).margin(TOL));
    }

    SECTION("double precision tests EV") {
        constexpr double TOL = 1e-7;
        helpme::Matrix<double> forcesD(6, 3);
        forcesD.setZero();
        double ccelec = 332.0716;

        auto pmeD = std::unique_ptr<PMEInstanceD>(new PMEInstanceD);
        pmeD->setupCompressed(1, 0.3, splineOrder, nfftx, nffty, nfftz, kMaxX, kMaxY, kMaxZ, ccelec, 1);
        pmeD->setLatticeVectors(20, 20, 20, 90, 90, 90, PMEInstanceD::LatticeType::XAligned);
        auto realGrid = pmeD->spreadParameters(0, chargesD, coordsD);
        helpme::Matrix<double> chargeGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refChargeGridD.almostEquals(chargeGrid, TOL));

        auto gridAddress = pmeD->compressedForwardTransform(realGrid);
        helpme::Matrix<double> transformedGrid(gridAddress, kDimY * kDimX, kDimZ);
        REQUIRE(refTransGridD.almostEquals(transformedGrid, TOL));

        helpme::Matrix<double> virial(6, 1);
        double *convolvedGrid;
        double energy = pmeD->convolveEV(gridAddress, convolvedGrid, virial);
        REQUIRE(refVirialD.almostEquals(virial, TOL));

        helpme::Matrix<double> convolvedGridMat(convolvedGrid, kDimY * kDimX, kDimZ);
        REQUIRE(refConvolvedGridD.almostEquals(convolvedGridMat, TOL));

        realGrid = pmeD->compressedInverseTransform(convolvedGrid);
        helpme::Matrix<double> potentialGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refPotentialGridD.almostEquals(potentialGrid, TOL));

        pmeD->probeGrid(realGrid, 0, chargesD, coordsD, forcesD);

        REQUIRE(refForcesD.almostEquals(forcesD, TOL));
        REQUIRE(refRecEnergy == Approx(energy).margin(TOL));
    }

    SECTION("single precision tests E") {
        constexpr float TOL = 5e-5;
        helpme::Matrix<float> forcesF(6, 3);
        forcesF.setZero();
        float ccelec = 332.0716f;

        auto pmeF = std::unique_ptr<PMEInstanceF>(new PMEInstanceF);
        pmeF->setupCompressed(1, 0.3, splineOrder, nfftx, nffty, nfftz, kMaxX, kMaxY, kMaxZ, ccelec, 1);
        pmeF->setLatticeVectors(20, 20, 20, 90, 90, 90, PMEInstanceF::LatticeType::XAligned);
        auto realGrid = pmeF->spreadParameters(0, chargesD.cast<float>(), coordsD.cast<float>());
        helpme::Matrix<float> chargeGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refChargeGridD.cast<float>().almostEquals(chargeGrid, TOL));

        auto gridAddress = pmeF->compressedForwardTransform(realGrid);
        helpme::Matrix<float> transformedGrid(gridAddress, kDimY * kDimX, kDimZ);
        REQUIRE(refTransGridD.cast<float>().almostEquals(transformedGrid, TOL));

        float energy = pmeF->convolveE(gridAddress);
        helpme::Matrix<float> convolvedGrid(gridAddress, kDimY * kDimX, kDimZ);
        REQUIRE(refConvolvedGridD.cast<float>().almostEquals(convolvedGrid, TOL));

        realGrid = pmeF->compressedInverseTransform(gridAddress);
        helpme::Matrix<float> potentialGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refPotentialGridD.cast<float>().almostEquals(potentialGrid, TOL));

        pmeF->probeGrid(realGrid, 0, chargesD.cast<float>(), coordsD.cast<float>(), forcesF);
        REQUIRE(refForcesD.cast<float>().almostEquals(forcesF, TOL));
        REQUIRE(refRecEnergy == Approx(energy).margin(TOL));
    }

    SECTION("single precision tests EV") {
        constexpr float TOL = 5e-5;
        helpme::Matrix<float> forcesF(6, 3);
        forcesF.setZero();
        float ccelec = 332.0716f;

        auto pmeF = std::unique_ptr<PMEInstanceF>(new PMEInstanceF);
        pmeF->setupCompressed(1, 0.3, splineOrder, nfftx, nffty, nfftz, kMaxX, kMaxY, kMaxZ, ccelec, 1);
        pmeF->setLatticeVectors(20, 20, 20, 90, 90, 90, PMEInstanceF::LatticeType::XAligned);
        auto realGrid = pmeF->spreadParameters(0, chargesD.cast<float>(), coordsD.cast<float>());
        helpme::Matrix<float> chargeGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refChargeGridD.cast<float>().almostEquals(chargeGrid, TOL));

        auto gridAddress = pmeF->compressedForwardTransform(realGrid);
        helpme::Matrix<float> transformedGrid(gridAddress, kDimY * kDimX, kDimZ);
        REQUIRE(refTransGridD.cast<float>().almostEquals(transformedGrid, TOL));

        helpme::Matrix<float> virial(6, 1);
        float *convolvedGrid;
        float energy = pmeF->convolveEV(gridAddress, convolvedGrid, virial);
        helpme::Matrix<float> convolvedGridMat(convolvedGrid, kDimY * kDimX, kDimZ);
        REQUIRE(refVirialD.cast<float>().almostEquals(virial, TOL));
        REQUIRE(refConvolvedGridD.cast<float>().almostEquals(convolvedGridMat, TOL));

        realGrid = pmeF->compressedInverseTransform(convolvedGrid);
        helpme::Matrix<float> potentialGrid(realGrid, nfftz * nffty, nfftx);
        REQUIRE(refPotentialGridD.cast<float>().almostEquals(potentialGrid, TOL));

        pmeF->probeGrid(realGrid, 0, chargesD.cast<float>(), coordsD.cast<float>(), forcesF);
        REQUIRE(refForcesD.cast<float>().almostEquals(forcesF, TOL));
        REQUIRE(refRecEnergy == Approx(energy).margin(TOL));
    }
}
